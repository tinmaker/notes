(function(b){var a=a||{};b.fn.czCombobox=function(d){var e="czCombobox";var c=b(this).data(e);if(typeof d=="string"&&d=="instance"){return c}var d=b.extend({},a.czCombobox.defaults,d||{});return b(this).each(function(){var g=b(document).data(e)||0;g++;var f=new a.czCombobox(d,g);f.$element=b(this);f._init();b(document).data(e,g);b(this).data(e,f)})};a.czCombobox=function(c,d){this.NAME="czCombobox";this.VERSION="1.0";this.pluginId=this.NAME+"_"+d;this.options=c;this.currentIndex=-1;this.keys=[];this.prevKey=false;this.focus=false;this.maxZindex="czComboxbox_max_zIndex"};a.czCombobox.defaults={className:"",zIndex:99,dropSpeed:0,maxHeight:200,dropUp:true,hideSelected:false,initCallback:null,blurCallback:null,focusCallback:null,changeCallback:null,showListCallback:null,hideListCallback:null};a.czCombobox.prototype={_init:function(){b(document).data(this.maxZindex)||b(document).data(this.maxZindex,this.options.zIndex);var c=this;this._create();this._initList();b(window).resize(function(){c._initList()});b(window).scroll(function(){c._initList()});this._selectIndex(true);this._bindEvent()},debug:function(c){if(typeof c=="undefined"){c=this}if(window.console&&window.console.log){window.console.log(c)}else{alert(c)}},_create:function(){var c=this;this.$wrap=b("<div />").addClass("czCombobox");this.$input=b('<input type="text" />').addClass("combobox_txt").attr("readonly",true);this.$ul=b("<ul />").addClass("combobox_list");this.$icon=b("<div />").addClass("combobox_icon");this.$wrap.attr("id",this.pluginId).addClass(this.options.className).css({position:"relative",zIndex:this.options.zIndex});this.$ul.css({overflow:"auto",position:"absolute"});if(typeof this.$element.attr("tabindex")!="underfine"){this.$input.attr("tabindex",this.$element.attr("tabindex"));this.$element.removeAttr("tabindex")}else{this.$input.attr("tabindex",0)}this.$wrap.insertAfter(this.$element);this.$input.prependTo(this.$wrap);this.$icon.prependTo(this.$wrap);this.$ul.appendTo(this.$wrap);var f="";if(this.$element.children("optgroup").length==0){this.$element.children().each(function(g){f+=c._setOptionHTML(b(this),g)})}else{var d=-1;this.$element.children().each(function(g){++d;if(b(this)[0].tagName.toUpperCase()=="OPTION"){f+=c._setOptionHTML(b(this),d)}else{f+='<li class="optgroup">'+b(this).attr("label")+"<ul>";b(this).children().each(function(){f+=c._setOptionHTML(b(this),d)});f+="</ul></li>"}})}this.$ul.show();this.$ul.html(f);this.$li=this.$ul.find("li:not(.optgroup)");if(this.$element.is(":visible")==false){var e=b("<div />").css({position:"absolute",left:"-9999px"}).appendTo("body");this.$wrap.clone().appendTo(e);this.ulHeight=e.find(".combobox_list").height();this.wrapHeight=e.find(".czCombobox").height();e.remove()}else{this.ulHeight=this.$ul.height();this.wrapHeight=this.$wrap.height()}this.liCounts=this.$li.length;this.$element.hide()},_initList:function(){var d=this.$wrap.offset().top;var c=b(window).height();var e=b(window).scrollTop();if(this.ulHeight>parseInt(this.options.maxHeight)){this.ulHeight=parseInt(this.options.maxHeight);this.$ul.css("overflow","auto")}this.onTop=false;this.$ul.css({top:this.wrapHeight+"px",height:this.ulHeight});if(this.options.dropUp!=false){d=d-e;if(d+this.ulHeight>=c){this.onTop=true;this.$ul.css({top:"-"+this.ulHeight+"px",height:this.ulHeight})}}},_bindEvent:function(){var c=this;this.$li.bind({mouseenter:function(d){if(d.target.nodeName=="LI"){var f=b(d.target)}else{var f=b(d.target).parentsUntil("ul")}f.addClass("li_hover")},mouseleave:function(d){if(d.target.nodeName=="LI"){var f=b(d.target)}else{var f=b(d.target).parentsUntil("ul")}f.removeClass("li_hover")}});this.$wrap.bind({mouseenter:function(){c.$input.addClass("box_hover")},mouseleave:function(){c.$input.removeClass("box_hover")},click:function(){c.$input.trigger("czfocus");if(c.$ul.is(":visible")){c.hideComboList()}else{c.showComboList();c.$ul.scrollTop(c.liOffsetTop)}}});this.$input.bind("czfocus",function(){if(c.focus==true){return}c.focus=true;c.$input.addClass("box_focus");c.keyPress();c._callback("focus")}).bind("czblur",function(){if(c.focus==false){return}c.focus=false;c.$input.removeClass("box_focus");c.$wrap.unbind("keydown");c.hideComboList();c._callback("blur")});b(document).bind("mousedown",function(g){var d=c.$ul.has(b(g.target)).attr("class");if(typeof d!="undefined"){if(g.target.nodeName=="LI"){var h=b(g.target)}else{var h=b(g.target).parentsUntil("ul")}c.currentIndex=c.$li.index(h);c._selectIndex();c.hideComboList();return}else{var f=c.$wrap.has(b(g.target)).attr("id");if(typeof f=="undefined"){c.$input.trigger("czblur")}}})},_setOptionHTML:function(f,e){var d=f.text();var c="<li>"+d+"</li>";this.keys.push(d.charAt(0).toLowerCase());if(f.attr("selected")==true){this.currentIndex=e;if(this.options.hideSelected!=false){c='<li style="display:none">'+d+"</li>"}}return c},_selectIndex:function(f){if(f==true){this.$ul.css("visibility","hidden")}var d=this.$wrap.offset().top,g=this.$li.eq(this.currentIndex).offset().top,c=this.$ul.scrollTop();if(this.onTop==true){this.liOffsetTop=(((g-d)-this.wrapHeight)+c)+parseInt(this.options.maxHeight)}else{this.liOffsetTop=((g-d)-this.wrapHeight)+c}this.$ul.scrollTop(this.liOffsetTop);if(this.options.hideSelected!=false){this.$li.show().eq(this.currentIndex).hide()}else{this.$li.removeClass("li_selected").eq(this.currentIndex).addClass("li_selected")}var e=this.$li.eq(this.currentIndex).text();if(f==true){this.$input.val(e);this.$ul.css("visibility","").hide();this._callback("init");return false}if(this.$element[0].selectedIndex!=this.currentIndex){this.$element[0].selectedIndex=this.currentIndex;this.$input.val(e);this._callback("change")}},_getKey:function(d,e){for(var c=(e||0);c<this.keys.length;c++){if(this.keys[c]==d){return c}}return -1},_callback:function(c){if(typeof this.options[c+"Callback"]!="function"){return}this.options[c+"Callback"].call(this)},showComboList:function(){b(document).data(this.maxZindex,b(document).data(this.maxZindex)+1);this.$wrap.css("zIndex",b(document).data(this.maxZindex));this.$ul.slideDown(this.options.dropSpeed);this._callback("showList")},hideComboList:function(){this.$ul.hide();this._callback("hideList")},keyPress:function(){var c=this;this.$wrap.keydown(function(h){if(h==null){var f=event.keyCode}else{var f=h.which}switch(f){case 40:case 39:c.gotoNext();return false;break;case 38:case 37:c.gotoPrev();return false;break;case 33:case 36:c.gotoFirst();return false;break;case 34:case 35:c.gotoLast();return false;break;case 13:case 27:c.hideComboList();return false;break}var g=String.fromCharCode(f).toLowerCase();var d=c._getKey(g);if(d!=-1){++c.currentIndex;c.currentIndex=c._getKey(g,c.currentIndex);if(c.currentIndex==-1||c.currentIndex==null||c.prevKey!=g){c.currentIndex=c._getKey(g)}c._selectIndex();c.prevKey=g;return false}})},gotoNext:function(){if(this.currentIndex<(this.liCounts-1)){++this.currentIndex;this._selectIndex()}},gotoPrev:function(){if(this.currentIndex>0){--this.currentIndex;this._selectIndex()}},gotoFirst:function(){this.currentIndex=0;this._selectIndex()},gotoLast:function(){this.currentIndex=this.liCounts-1;this._selectIndex()},getText:function(){return this.$li.eq(this.currentIndex).text()},getValue:function(){return this.$element.val()},setFocus:function(){return this.$input.trigger("czfocus")},reload:function(){this.currentIndex=0;this._selectIndex(true)},rebuild:function(){this.$wrap.remove();this._init()},setOption:function(d){var c=this;if(typeof d=="undefined"){c.currentIndex=0;c._selectIndex();return}this.$element.find("option").each(function(e){try{if(b(this).val()==d){throw e}}catch(e){c.currentIndex=e;c._selectIndex();return}})}}})(jQuery);